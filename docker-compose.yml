services:

  # ─── Banco de dados MySQL ────────────────────────────────────────────────────
  mysql:
    image: mysql:8.0
    container_name: servja_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_servja_local
      MYSQL_DATABASE: servija
      MYSQL_USER: servija
      MYSQL_PASSWORD: Fe230599@
    ports:
      - "3307:3306"
    volumes:
      - servja_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_servja_local"]
      interval: 5s
      timeout: 5s
      retries: 15
      start_period: 20s

  # ─── Backend Express (API) ───────────────────────────────────────────────────
  api:
    image: node:22-alpine
    container_name: servja_api
    working_dir: /app
    restart: unless-stopped
    volumes:
      - .:/app
      - servja_api_node_modules:/app/node_modules
    ports:
      - "3002:3001"
    depends_on:
      mysql:
        condition: service_healthy
    env_file:
      - .env.local
    command: sh -c "npm install --prefer-offline --silent && node --watch server/index.js"

  # ─── Frontend Vite (dev server) ──────────────────────────────────────────────
  frontend:
    image: node:22-alpine
    container_name: servja_frontend
    working_dir: /app
    restart: unless-stopped
    volumes:
      - .:/app
      - servja_frontend_node_modules:/app/node_modules
    ports:
      - "5173:5173"
    depends_on:
      - api
    environment:
      - VITE_API_PROXY_TARGET=http://api:3001
    command: sh -c "npm install --prefer-offline --silent && npx vite --host 0.0.0.0"

# ─── Volumes persistentes ─────────────────────────────────────────────────────
volumes:
  servja_mysql_data:
    driver: local
  servja_api_node_modules:
    driver: local
  servja_frontend_node_modules:
    driver: local
